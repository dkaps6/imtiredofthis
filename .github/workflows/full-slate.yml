name: Full Slate

on:
  workflow_dispatch:
    inputs:
      season:
        description: "Season (e.g., 2025)"
        required: false
        default: "2025"
      date:
        description: "Slate date (YYYY-MM-DD) or blank for latest"
        required: false
        default: ""

concurrency:
  group: full-slate-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  PYTHONDONTWRITEBYTECODE: "1"
  PIP_DISABLE_PIP_VERSION_CHECK: "1"
  APISPORTS_KEY: ${{ secrets.APISPORTS_KEY }}
  ODDS_API_KEY: ${{ secrets.ODDS_API_KEY }}
  ESPN_COOKIE: ${{ secrets.ESPN_COOKIE }}
  MSF_KEY: ${{ secrets.MSF_KEY }}
  MSF_PASSWORD: ${{ secrets.MSF_PASSWORD }}
  NFLGSIS_USERNAME: ${{ secrets.NFLGSIS_USERNAME }}
  NFLGSIS_PASSWORD: ${{ secrets.NFLGSIS_PASSWORD }}
  SEASON: ${{ github.event.inputs.season }}
  SLATE_DATE: ${{ github.event.inputs.date }}

jobs:
  full_slate:
    name: Full slate (single job)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps (core + HTML parsers)
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install extra deps for props script
        run: |
          python -m pip install --upgrade pip
          python -m pip install "pandas==1.5.3"

      - name: Echo config
        run: |
          echo "Season: ${SEASON}"
          echo "Slate date: ${SLATE_DATE:-<empty>}"

      # 1) Build depth / roles (Ourlads) and validate
      - name: Build depth / roles (Ourlads)
        run: |
          export PYTHONPATH="${PWD}"
          python scripts/providers/ourlads_depth.py \
            --season "${SEASON}"
          mkdir -p outputs
          cp data/roles_ourlads.csv outputs/roles_ourlads.csv

          if [ ! -f data/roles_ourlads.csv ]; then
            echo "ERROR: data/roles_ourlads.csv not found after Ourlads build."
            exit 1
          fi
          lines=$(wc -l < data/roles_ourlads.csv || echo 0)
          echo "roles_ourlads.csv lines=${lines}"
          if [ "$lines" -le 1 ]; then
            echo "ERROR: data/roles_ourlads.csv exists but has <= 1 line."
            exit 1
          fi

      # 2) Build team-week map
      - name: Build team-week map (authoritative opponents)
        env:
          TEAM_WEEK_MAP_CSV: data/team_week_map.csv
          SEASON: ${{ env.SEASON }}
          SLATE_DATE: ${{ env.SLATE_DATE }}
        run: |
          export PYTHONPATH="${PWD}"
          SCHED=""
          if [ -f "data/schedules/schedule_${SEASON}.csv" ]; then
            SCHED="--schedule data/schedules/schedule_${SEASON}.csv"
          fi
          python scripts/utils/make_team_week_map.py --season "${SEASON}" ${SCHED}

          if [ ! -s data/team_week_map.csv ]; then
            echo "ERROR: data/team_week_map.csv missing or empty after make_team_week_map."
            exit 1
          fi

      # 3) Fetch props + odds board
      - name: Fetch player props / odds board
        env:
          TEAM_WEEK_MAP_CSV: data/team_week_map.csv
          ROLES_CSV: data/roles_ourlads.csv
          SEASON: ${{ env.SEASON }}
          SLATE_DATE: ${{ env.SLATE_DATE }}
          APISPORTS_KEY: ${{ secrets.APISPORTS_KEY }}
          ODDS_API_KEY: ${{ secrets.ODDS_API_KEY }}
          ESPN_COOKIE: ${{ secrets.ESPN_COOKIE }}
          MSF_KEY: ${{ secrets.MSF_KEY }}
          MSF_PASSWORD: ${{ secrets.MSF_PASSWORD }}
          NFLGSIS_USERNAME: ${{ secrets.NFLGSIS_USERNAME }}
          NFLGSIS_PASSWORD: ${{ secrets.NFLGSIS_PASSWORD }}
        run: |
          export PYTHONPATH="${PWD}"
          python scripts/fetch_props_oddsapi.py \
            --season "${SEASON}" \
            --date "${SLATE_DATE}"

          if [ -f outputs/props_enriched.csv ]; then
            echo "props_enriched.csv rows:"
            wc -l outputs/props_enriched.csv || true
          else
            echo "WARNING: outputs/props_enriched.csv not found."
          fi

      # 4) Build opponent map from props
      - name: Build opponent map from props
        run: |
          export PYTHONPATH="${PWD}"
          python -m compileall scripts/build/build_opponent_map_from_props.py
          python scripts/build/build_opponent_map_from_props.py

          if [ ! -s data/opponent_map_from_props.csv ]; then
            echo "ERROR: data/opponent_map_from_props.csv missing or empty."
            exit 1
          fi

      # 5) Pull SharpFootball metrics + build team_form
      - name: Pull SharpFootball metrics
        run: |
          export PYTHONPATH="${PWD}"
          python scripts/providers/sharpfootball_pull.py \
            --season "${SEASON}" \
            --dump-html

      - name: Build team_form
        run: |
          export PYTHONPATH="${PWD}"
          python scripts/make_team_form.py \
            --season "${SEASON}"

          if [ ! -s data/team_form.csv ]; then
            echo "ERROR: data/team_form.csv missing or empty after make_team_form."
            exit 1
          fi

      # 6) Build weather (best-effort)
      - name: Build weather (per-game forecast)
        continue-on-error: true
        run: |
          export PYTHONPATH="${PWD}"
          python scripts/build/build_weather_week.py \
            --season "${SEASON}" \
            --date "${SLATE_DATE}"

      # 7) Stage and validate PlayerForm inputs
      - name: Stage PlayerForm inputs (schedule required, logs optional)
        run: |
          echo "Staging PlayerForm inputs (schedule required, logs optional)..."
          mkdir -p data/staging

          # team_week_map is still REQUIRED
          if [ ! -s data/team_week_map.csv ]; then
            echo "ERROR: data/team_week_map.csv is missing or empty"
            ls -l data || true
            exit 1
          fi
          cp data/team_week_map.csv data/staging/ || exit 1

          # player_game_logs / player_season_totals are OPTIONAL here.
          # When using the PBP-based builder, make_player_form.py will
          # fetch and write them as side-effects; they do not need to
          # exist before that step runs.
          for f in data/player_game_logs.csv data/player_season_totals.csv; do
            if [ -f "$f" ]; then
              echo "Found optional input: $f"
              cp "$f" data/staging/ || true
            else
              echo "NOTE: $f not present before make_player_form; it will be created (if needed) by the PBP-based builder."
            fi
          done

          echo "Row counts for staged PlayerForm inputs (if any):"
          if ls data/staging/*.csv >/dev/null 2>&1; then
            wc -l data/staging/*.csv || true
          else
            echo "(no staged CSVs yet)"
          fi

      # 8) Build player_form / consensus (legacy CSV-based)
      - name: Build Player Form (authoritative step)
        run: |
          python scripts/make_player_form.py

          if [ ! -s data/player_game_logs.csv ]; then
            echo "❌ player_game_logs.csv missing or empty"
            exit 1
          fi

          # HARD FAIL IF EMPTY
          python - <<'EOF'
          import pandas as pd
          import sys
          df = pd.read_csv("data/player_form.csv")
          if df.empty:
              sys.exit("FATAL: player_form.csv is empty")
          EOF

      # 9) Run full metrics pipeline
      - name: Run full metrics pipeline
        run: |
          export PYTHONPATH="${PWD}"
          python scripts/make_metrics.py \
            --season "${SEASON}" \
            --mode full \
            --date "${SLATE_DATE}"

      # 10) Validate metrics_ready before pricing
      - name: Validate metrics_ready (must pass before pricing)
        run: |
          export PYTHONPATH="${PWD}"
          python scripts/metrics_ready.py \
            --season "${SEASON}" \
            --date "${SLATE_DATE}"

      # 11) Run pricing model
      - name: Run pricing model
        run: |
          export PYTHONPATH="${PWD}"
          python scripts/pricing.py \
            --season "${SEASON}"

      # 12) Optional: CSV row-count summary for quick debugging
      - name: Summarize CSV row counts
        run: |
          echo "=== Row counts under data/ ==="
          find data -maxdepth 2 -name "*.csv" -print0 | xargs -0 -I{} sh -c 'echo "--- {}"; wc -l "{}" || true'

          echo "=== Row counts under outputs/ ==="
          if [ -d outputs ]; then
            find outputs -maxdepth 2 -name "*.csv" -print0 | xargs -0 -I{} sh -c 'echo "--- {}"; wc -l "{}" || true'
          fi

      # 13) Unified artifact – everything in one bundle
      - name: Upload artifacts (always)
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: run_${{ github.run_id }}
          path: |
            data/**
            outputs/**
            data/_debug/**
            data/_sharp_dump_*.html
          if-no-files-found: warn
          retention-days: 7
