name: Full Slate

on:
  workflow_dispatch:
    inputs:
      season:
        description: "Season (e.g. 2025)"
        required: false
        default: "2025"
      date:
        description: "Slate date (YYYY-MM-DD) or blank for latest"
        required: false
        default: ""

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    env:
      # your existing knobs
      MC_TRIALS: "25000"
      PYTHONUNBUFFERED: "1"
      # strict mode makes builders fail fast if they returned stub/empty data
      NFL_FORM_STRICT: "1"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      # --- Install dependencies BEFORE running the engine ---
      - name: Install requirements
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install --prefer-binary -r requirements.txt

      # Replace the old duplicate "Install deps" with this quick import check
      - name: Verify deps (nfl_data_py / pyarrow)
        run: |
          python - <<'PY'
          import sys, importlib
          for m in ["nfl_data_py", "pyarrow", "pandas", "numpy"]:
              try:
                  mod = importlib.import_module(m)
                  print(f"{m}: OK", getattr(mod, "__version__", "(no __version__)"))
              except Exception as e:
                  print(f"{m}: FAIL -> {e}")
                  sys.exit(1)
          PY

      - name: Prepare dirs
        run: |
          mkdir -p data outputs outputs/metrics logs

      - name: Add repo to PYTHONPATH
        run: echo "PYTHONPATH=$PWD" >> $GITHUB_ENV

      - name: Run pipeline
        run: |
          python -m engine --season "${{ inputs.season || '2025' }}" --date "${{ inputs.date || '' }}"

      # Always ship artifacts (snapshots, logs, partial CSVs) even if the run fails
      - name: Upload artifacts (always)
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: run-${{ github.run_id }}
          path: |
            runs/**/*.zip
            runs/**/*
            outputs/**
            data/**
            logs/**
