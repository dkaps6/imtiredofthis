name: Run full slate

on:
  workflow_dispatch:
    inputs:
      season:
        description: "Season year"
        required: true
        default: "2025"
      date:
        description: 'Slate date (YYYY-MM-DD). Leave blank "" for upcoming.'
        required: false
        default: ""
      bookmakers:
        description: 'Comma list (e.g. "draftkings,fanduel,betmgm,caesars"). Use "" for ALL books.'
        required: false
        default: "draftkings,fanduel,betmgm,caesars"

jobs:
  run:
    runs-on: ubuntu-latest
    env:
      ODDS_API_KEY: ${{ secrets.ODDS_API_KEY }}
      ESPN_COOKIE: ${{ secrets.ESPN_COOKIE }}
      NFL_FORM_STRICT: "1"
      MC_TRIALS: "25000"
      PYTHONUNBUFFERED: "1"

    steps:
      - name: Check out repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          python -m pip cache purge || true
          python -m pip install -r requirements.txt

      - name: Build team & player features (2025 only)
        run: |
          python -m scripts.providers.gsis_pull 2025 || true
          python -m scripts.providers.espn_pull || true
          python -m scripts.providers.apisports_pull 2025 || true
          python -m scripts.providers.msf_pull 2025 || true
          python -m scripts.providers.ourlads_depth || true
          python -m scripts.providers.injuries 2025 || true
          python -m scripts.make_team_form --season 2025 --strict
          python -m scripts.make_player_form --season 2025 --strict
          python -m scripts.enrich_team_form --season 2025 || true
          python -m scripts.enrich_player_form --season 2025 || true

      - name: Fetch props + H2H from Odds API
        run: |
          python -m scripts.fetch_props_oddsapi \
            --season "${{ github.event.inputs.season }}" \
            --date   "${{ github.event.inputs.date }}" \
            --bookmakers "${{ github.event.inputs.bookmakers }}"

      - name: Price + export
        run: |
          python -m scripts.pricing --season 2025 --write outputs
          python -m scripts.export_excel --season 2025 --out runs/props_2025_${{ github.run_id }}.xlsx || true

      - name: Upload run artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: run-artifacts
          path: |
            runs/**/*.xlsx
            outputs/**
            data/**
            logs/**
          if-no-files-found: warn
