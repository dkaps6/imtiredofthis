name: Full Slate

on:
  workflow_dispatch:
    inputs:
      season:
        description: "Season (e.g., 2025)"
        required: false
        default: "2025"
      date:
        description: "Slate date (YYYY-MM-DD) or blank for latest"
        required: false
        default: ""

concurrency:
  group: full-slate-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  PYTHONDONTWRITEBYTECODE: "1"
  PIP_DISABLE_PIP_VERSION_CHECK: "1"
  APISPORTS_KEY: ${{ secrets.APISPORTS_KEY }}
  ODDS_API_KEY: ${{ secrets.ODDS_API_KEY }}
  ESPN_COOKIE: ${{ secrets.ESPN_COOKIE }}
  MSF_KEY: ${{ secrets.MSF_KEY }}
  MSF_PASSWORD: ${{ secrets.MSF_PASSWORD }}
  NFLGSIS_USERNAME: ${{ secrets.NFLGSIS_USERNAME }}
  NFLGSIS_PASSWORD: ${{ secrets.NFLGSIS_PASSWORD }}
  SEASON: ${{ github.event.inputs.season }}
  SLATE_DATE: ${{ github.event.inputs.date }}

jobs:
  setup_python:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps (core + HTML parsers)
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi

  build_team_week_map:
    runs-on: ubuntu-latest
    needs: [setup_python, build_depth_roles_ourlads]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps (core + HTML parsers)
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi

      - name: Build team-week map (authoritative opponents)
        run: |
          export PYTHONPATH="${PWD}"
          SCHED=""
          if [ -f "data/schedules/schedule_${SEASON}.csv" ]; then
            SCHED="--schedule data/schedules/schedule_${SEASON}.csv"
          fi
          python scripts/utils/make_team_week_map.py --season "${SEASON}" ${SCHED}

      - name: Persist state
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: state-build_team_week_map
          path: |
            data/**
            outputs/**
          if-no-files-found: ignore
          retention-days: 7

  fetch_player_props_odds_board:
    runs-on: ubuntu-latest
    needs: [build_team_week_map, build_depth_roles_ourlads]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Restore state from fetch_player_props_odds_board
        if: always()
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: state-fetch_player_props_odds_board
          path: previous_state

      - name: Ensure previous_state exists
        run: mkdir -p previous_state && ls -la previous_state || true

      - name: Merge previous state
        run: |
          if [ -d previous_state ]; then
            cp -a previous_state/. .
          fi

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps (core + HTML parsers)
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi

      - name: Download roles_ourlads artifact
        uses: actions/download-artifact@v4
        with:
          name: roles_ourlads
          path: .

      - name: Restore state from build_depth_roles_ourlads
        uses: actions/download-artifact@v4
        with:
          name: state-build_depth_roles_ourlads
          path: .

      - name: Ensure roles_ourlads.csv exists and is non-empty
        run: |
          set -euo pipefail

          candidates=("data/roles_ourlads.csv" "outputs/roles_ourlads.csv")
          chosen=""

          echo "Looking for roles_ourlads.csv in:"
          for c in "${candidates[@]}"; do
            if [ -f "$c" ]; then
              lines="$(wc -l < "$c" || echo 0)"
              echo "  - $c (lines=$lines)"
              if [ "$lines" -gt 1 ]; then
                chosen="$c"
                break
              fi
            else
              echo "  - $c (missing)"
            fi
          done

          if [ -z "$chosen" ]; then
            echo "ERROR: Could not locate a non-empty roles_ourlads.csv in any of: ${candidates[*]}"
            echo "       Check the 'Build depth / roles (Ourlads)' step for scraper/site issues."
            exit 1
          fi

          echo "Using roles file: $chosen"
          echo "ROLES_CSV=$chosen" >> "$GITHUB_ENV"

      - name: Fetch player props / odds board
        run: |
          export PYTHONPATH="${PWD}"
          python -m scripts.fetch_props_oddsapi --season "${SEASON}" --date "${SLATE_DATE}" --roles-csv "${ROLES_CSV}"

        env:
          PYTHONPATH: .

      - name: Persist state
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: state-fetch_player_props_odds_board
          path: |
            data/**
            outputs/**
          if-no-files-found: ignore
          retention-days: 7

  build_opponent_map_from_props:
    runs-on: ubuntu-latest
    needs: [build_team_week_map, fetch_player_props_odds_board]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Restore state from fetch_player_props_odds_board
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: state-fetch_player_props_odds_board
          path: previous_state
          merge-multiple: false
          repository: dkaps6/imtiredofthis
          run-id: 19411229739
          if-no-files-found: ignore

      - name: Merge previous state
        run: |
          if [ -d previous_state ]; then
            cp -a previous_state/. .
          fi

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps (core + HTML parsers)
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi

      - name: Build opponent map from props
        run: |
          export PYTHONPATH="${PWD}"
          python -m compileall scripts/build/build_opponent_map_from_props.py
          python scripts/build/build_opponent_map_from_props.py

      - name: Persist state
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: state-build_opponent_map_from_props
          path: |
            data/**
            outputs/**
          if-no-files-found: ignore
          retention-days: 7

  build_depth_roles_ourlads:
    runs-on: ubuntu-latest
    needs: [setup_python]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps (core + HTML parsers)
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi

      - name: Build depth / roles (Ourlads)
        run: |
          export PYTHONPATH="${PWD}"
          python scripts/providers/ourlads_depth.py \
            --season "${SEASON}"

      - name: Upload roles_ourlads.csv
        uses: actions/upload-artifact@v4
        with:
          name: roles_ourlads
          path: outputs/roles_ourlads.csv

      - name: Persist state
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: state-build_depth_roles_ourlads
          path: |
            data/**
            outputs/**
          if-no-files-found: ignore
          retention-days: 7

  build_player_form_consensus:
    runs-on: ubuntu-latest
    needs: [build_opponent_map_from_props, build_depth_roles_ourlads]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Restore state from build_opponent_map_from_props
        uses: actions/download-artifact@v4
        with:
          name: state-build_opponent_map_from_props
          path: opponent_state

      - name: Restore roles state
        uses: actions/download-artifact@v4
        with:
          name: state-build_depth_roles_ourlads
          path: roles_state

      - name: Merge previous state
        run: |
          if [ -d opponent_state ]; then
            cp -a opponent_state/. .
          fi
          if [ -d roles_state ]; then
            cp -a roles_state/. .
          fi

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps (core + HTML parsers)
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi

      - name: Build player_form / consensus
        run: |
          export PYTHONPATH="${PWD}"
          python scripts/make_player_form.py \
            --season "${SEASON}" \
            --date "${SLATE_DATE}"

      - name: Persist state
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: state-build_player_form_consensus
          path: |
            data/**
            outputs/**
          if-no-files-found: ignore
          retention-days: 7

  build_team_form:
    runs-on: ubuntu-latest
    needs: [build_team_week_map]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Restore state from build_team_week_map
        uses: actions/download-artifact@v4
        with:
          name: state-build_team_week_map
          path: previous_state

      - name: Merge previous state
        run: |
          if [ -d previous_state ]; then
            cp -a previous_state/. .
          fi

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps (core + HTML parsers)
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi

      - name: Pull SharpFootball metrics
        run: |
          export PYTHONPATH="${PWD}"
          python scripts/providers/sharpfootball_pull.py \
            --season "${SEASON}" \
            --dump-html

      - name: Build team_form
        run: |
          export PYTHONPATH="${PWD}"
          python scripts/make_team_form.py \
            --season "${SEASON}"

      - name: Persist state
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: state-build_team_form
          path: |
            data/**
            outputs/**
          if-no-files-found: ignore
          retention-days: 7

  build_weather:
    runs-on: ubuntu-latest
    needs: [fetch_player_props_odds_board]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Restore state from build_team_week_map
        uses: actions/download-artifact@v4
        with:
          name: state-build_team_week_map
          path: previous_state

      - name: Merge previous state
        run: |
          if [ -d previous_state ]; then
            cp -a previous_state/. .
          fi

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps (core + HTML parsers)
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi

      - name: Build weather (per-game forecast)
        continue-on-error: true
        run: |
          export PYTHONPATH="${PWD}"
          python scripts/build/build_weather_week.py \
            --season "${SEASON}" \
            --date "${SLATE_DATE}"

      - name: Persist state
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: state-build_weather
          path: |
            data/**
            outputs/**
          if-no-files-found: ignore
          retention-days: 7

  run_pipeline_full_metrics:
    runs-on: ubuntu-latest
    needs: [build_player_form_consensus, build_team_form]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Restore state from build_player_form_consensus
        uses: actions/download-artifact@v4
        with:
          name: state-build_player_form_consensus
          path: player_form_state

      - name: Restore state from build_team_form
        uses: actions/download-artifact@v4
        with:
          name: state-build_team_form
          path: team_form_state

      - name: Merge previous state
        run: |
          if [ -d player_form_state ]; then
            cp -a player_form_state/. .
          fi
          if [ -d team_form_state ]; then
            cp -a team_form_state/. .
          fi

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps (core + HTML parsers)
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi

      - name: Build QB scramble / designed-run metrics
        run: |
          export PYTHONPATH="${PWD}"
          python scripts/build/build_qb_run_metrics.py \
            --season "${SEASON}"

      - name: Run pipeline (full metrics)
        run: |
          export PYTHONPATH="${PWD}"
          python scripts/make_metrics.py \
            --season "${SEASON}" \
            --mode full \
            --date "${SLATE_DATE}"

      - name: Persist state
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: state-run_pipeline_full_metrics
          path: |
            data/**
            outputs/**
          if-no-files-found: ignore
          retention-days: 7

  validate_metrics_ready:
    runs-on: ubuntu-latest
    needs: [run_pipeline_full_metrics]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Restore state from run_pipeline_full_metrics
        uses: actions/download-artifact@v4
        with:
          name: state-run_pipeline_full_metrics
          path: previous_state

      - name: Merge previous state
        run: |
          if [ -d previous_state ]; then
            cp -a previous_state/. .
          fi

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps (core + HTML parsers)
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi

      - name: Validate metrics_ready (must pass before pricing)
        run: |
          export PYTHONPATH="${PWD}"
          python scripts/metrics_ready.py \
            --season "${SEASON}" \
            --date "${SLATE_DATE}"

      - name: Persist state
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: state-validate_metrics_ready
          path: |
            data/**
            outputs/**
          if-no-files-found: ignore
          retention-days: 7

  elite_model_run_pricing:
    runs-on: ubuntu-latest
    needs: [validate_metrics_ready]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Restore state from validate_metrics_ready
        uses: actions/download-artifact@v4
        with:
          name: state-validate_metrics_ready
          path: previous_state

      - name: Merge previous state
        run: |
          if [ -d previous_state ]; then
            cp -a previous_state/. .
          fi

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps (core + HTML parsers)
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi

      - name: Elite model | Run pricing
        run: |
          export PYTHONPATH="${PWD}"
          python scripts/make_metrics.py \
            --season "${SEASON}" \
            --mode pricing \
            --date "${SLATE_DATE}"
          export PYTHONPATH="${PWD}"
          python scripts/pricing.py \
            --season "${SEASON}"

      - name: Upload artifacts (always)
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: run_${{ github.run_id }}
          path: |
            outputs/**
            data/*.csv
            data/_debug/**
            data/_sharp_dump_*.html
          if-no-files-found: warn
          retention-days: 7
