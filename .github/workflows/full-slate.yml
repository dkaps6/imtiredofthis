name: Run full slate

on:
  workflow_dispatch:
    inputs:
      season:
        description: "Season year"
        required: true
        default: "2025"
      date:
        description: 'Slate date (YYYY-MM-DD). Leave blank "" for upcoming.'
        required: false
        default: ""
      bookmakers:
        description: 'Comma list (e.g. "draftkings,fanduel,betmgm,caesars"). Use "" for ALL books.'
        required: false
        default: ""

jobs:
  pipeline:
    runs-on: ubuntu-latest
    env:
      ODDS_API_KEY: ${{ secrets.ODDS_API_KEY }}
      ESPN_COOKIE:  ${{ secrets.ESPN_COOKIE }}
      NFL_FORM_STRICT: "1"
      MC_TRIALS: "25000"
      PYTHONUNBUFFERED: "1"

    steps:
      - name: "Check out repo"
        uses: actions/checkout@v4

      - name: "Set up Python"
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          python -m pip cache purge || true
          python -m pip install -r requirements.txt

      - name: Inspect available nfl_data_py wheels
        run: |
          python -m pip index versions nfl_data_py || true

      # Optional: show which "engine" Python would import (for debugging only)
      - name: "Diagnostic: which engine would be imported?"
        run: |
          python - <<'PY'
          import sys, os
          print("[diag] CWD:", os.getcwd())
          try:
              import engine, inspect
              print("[diag] import engine ->", engine.__file__)
              print("[diag] sys.path[0]:", sys.path[0])
          except Exception as e:
              print("[diag] could not import engine:", e)
          PY

      # Run the full model pipeline
      - name: "Run pipeline"
        run: |
          set -e
          SEASON="${{ github.event.inputs.season }}"
          DATE="${{ github.event.inputs.date }}"
          BOOKS="${{ github.event.inputs.bookmakers }}"   # keep the GH input var if you like
          MARKETS="${{ github.event.inputs.markets }}"     # if you have one

          echo "â–¶ Running pipeline for season=$SEASON date=$DATE books=$BOOKS"
          python -m engine --season "$SEASON" --date "$DATE" --books "$BOOKS" --markets "$MARKETS"
          # or, if you don't pass markets:
          # python -m engine --season "$SEASON" --date "$DATE" --books "$BOOKS"


      - name: "Upload run artifacts"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: run-artifacts
          path: |
            runs/**/*.zip
            runs/**/*
            logs/**
            outputs/**
            data/**
          if-no-files-found: ignore
